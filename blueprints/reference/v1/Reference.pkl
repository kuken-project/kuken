// ============================================================================
// Küken BLUEPRINT REFERENCE SCHEMA
// ============================================================================

///
/// This module defines the complete configuration schema for Küken application
/// blueprints. Blueprints describe containerized applications with their inputs,
/// build configuration, environment variables, and metadata.
///
/// A Blueprint serves as a template that Küken uses to:
///   - Generate user configuration interfaces
///   - Build Docker containers with proper configuration
///   - Manage environment variables and secrets
///   - Handle port mappings and networking
///
/// See <https://kuken.io/docs/blueprints>
/// @version 1.0.0
/// ============================================================================
@ModuleInfo { minPklVersion = "0.30.2" }
module io.kuken.Blueprint

// ============================================================================
// MODULE DESCRIPTOR
// ============================================================================

/// The canonical name of the application or service.
/// This should be the official product name in title case.
///
/// **Example:** `"Minecraft: Java Edition"`, `"PostgreSQL Database"`
name: String(
  !isEmpty
    && length >= 3
    && length <= 100,
)

/// Semantic version of this blueprint definition following semver 2.0.0 specification.
/// This tracks blueprint changes, not the application version itself.
///
/// **Format:** `MAJOR.MINOR.PATCH[-prerelease][+build]`
///
/// **Example:** `"1.0.0"`, `"2.1.3-beta.1"`, `"1.2.0+20240115"`
///
/// See <https://semver.org> for more details.
version: String(matches(Regex(#"^\d+\.\d+\.\d+(-[a-zA-Z0-9.]+)?(\+[a-zA-Z0-9.]+)?$"#)))

/// Official website or documentation URL for the application.
///
/// This should point to:
///   - The official product homepage, OR
///   - Official documentation, OR
///   - GitHub/GitLab repository for open source projects
///
/// Must be a valid HTTPS URL (HTTP allowed for localhost development).
///
/// Examples:
///   - "https://www.postgresql.org"
///   - "https://github.com/itzg/docker-minecraft-server"
///   - "https://Küken.io"
///
/// @required
url: WebUrl

// ============================================================================
// TYPE DEFINITIONS - PRIMITIVES
// ============================================================================

const FILE_PROTOCOL = "file://"
const SECURE_WEB_PROTOCOL = "https://"
const INSECURE_WEB_PROTOCOL = "http://"

/// A valid URL or file path reference used throughout the blueprint.
///
/// Supported schemes:
///  * [WebURL]s
///  * file://  - Local filesystem paths
///  * url://   - Generic URL placeholder
///
typealias Source =
  WebUrl
    | FileURI
    | String(
      !isEmpty
        && (startsWith("url://")),
    )

typealias FileURI = String(!isEmpty && startsWith(FILE_PROTOCOL))

/// Web-only URL reference that excludes local file paths.
/// Used for public-facing URLs like documentation and official websites.
typealias WebUrl =
  String(
    !isEmpty
      && (startsWith(SECURE_WEB_PROTOCOL) || startsWith(INSECURE_WEB_PROTOCOL)),
  )

/// A valid Docker image reference with optional tag or digest.
///
/// Format patterns:
/// * Simple: "nginx"
/// * With tag: "nginx:latest", "postgres:15.2"
/// * With registry: "docker.io/library/nginx:alpine"
/// * With digest: "nginx@sha256:abc123..."
/// * Private registry: "myregistry.com:5000/myapp:v1.0.0"
///
/// Constraints:
/// * Must contain valid Docker image name characters
/// * Tag (after ':') is alphanumeric with dots, dashes, underscores
/// * Total length limited to 255 characters (Docker limitation)
///
/// Examples:
/// * "itzg/minecraft-server:latest"
/// * "postgres:15.2-alpine"
/// * "redis:7-alpine"
/// * "ghcr.io/company/app:v2.1.0"
///
/// See <https://docs.docker.com/engine/reference/commandline/tag/> for more details.
typealias DockerImageReference =
  String(
    !isEmpty
      && length <= 255
      && matches(
        Regex(
          #"^[a-z0-9]+(([._-]|__|[-]*)[a-z0-9]+)*(:[a-z0-9]+(([._-]|__|[-]*)[a-z0-9]+)*)?(/[a-z0-9]+(([._-]|__|[-]*)[a-z0-9]+)*(:[a-z0-9]+(([._-]|__|[-]*)[a-z0-9]+)*)?)*(@sha256:[a-f0-9]{64})?$"#,
        ),
      ),
  )

/// POSIX-compliant environment variable name in UPPER_SNAKE_CASE.
/// Must start with uppercase letter or underscore, containing only uppercase letters, numbers, and underscores.
///
/// **Example:** `"DATABASE_URL"`, `"MAX_CONNECTIONS"`, `"_INTERNAL_DEBUG"`
typealias EnvVarName =
  String(
    !isEmpty
      && length <= 255
      && matches(Regex(#"^[A-Z_][A-Z0-9_]*$"#)),
  )

function tcp(port: PortNumber): Port = new {
  value = port
  protocol = "tcp"
}

function udp(port: PortNumber): Port = new {
  value = port
  protocol = "udp"
}

typealias PortNumber =
  UInt16(
    this >= 1
      && this <= 65535,
  )

class Port {
  /// Valid TCP/UDP port number in the range 1-65535.
  ///
  /// Remember: Ports 1-1023 are system ports requiring elevated privileges.
  value: PortNumber

  protocol: NetworkProtocol
}

typealias NetworkProtocol = "tcp" | "udp"

/// Valid input identifier in kebab-case format.
/// Used for programmatic references to user inputs throughout the blueprint.
///
/// **Example:** `"database-password"`, `"rcon-port"`, `"max-memory"`
typealias InputId =
  String(
    !isEmpty
      && length >= 2
      && length <= 64
      && matches(Regex(#"^[a-z][a-z0-9-]*$"#)),
  )

/// Human-readable label for UI display in title case or sentence case.
/// Shown to users in the setup interface.
///
/// **Example:** `"Database Password"`, `"RCON Port"`, `"Maximum Memory Allocation"`
typealias DisplayLabel =
  String(
    !isEmpty
      && length >= 3
      && length <= 100,
  )

// ============================================================================
// TYPE DEFINITIONS - COMPOSITE
// ============================================================================

/// Property value that can reference [UserInput], [EnvironmentVariable] or [Ref] for dynamic substitution.
/// Enables both static values and runtime-resolved references.
typealias ResolvableProperty = String(!isEmpty) | Property

/// Collection of user input definitions presented during application setup.
/// Order determines display sequence in the UI.
typealias UserInputs = Listing<UserInput>

/// Collection of environment variables passed to the container at runtime.
/// Can contain static values or references to user inputs.
typealias EnvironmentVariables = Listing<EnvironmentVariable>

/// Supported value types for environment variables.
/// Küken handles type conversion to strings as needed by the container runtime.
typealias EnvVarValue = Char | String | Number | Boolean | Duration | DataSize | UserInput

// ============================================================================
// ABSTRACT BASE CLASSES
// ============================================================================
abstract class Base {
  /// Runtime values that are only available during blueprint instantiation.
  /// References provide access to system-generated values that don't exist when writing the blueprint,
  /// such as instance names, generated IDs, or assigned ports. Use refs to inject these dynamic runtime
  /// values into your configuration.
  ///
  /// **Example:** `${refs.instance.name}` resolves to the actual instance name at deployment time.
  fixed refs: RuntimeRefs = module.refs
}

function parameters(text: VarArgs<String>): String = List(text).join("")

function param(property: Property, value: (String) -> String): String =
  property.ref.value().ifNonNull((result) -> value.apply(result as String)) as String

/// Marker interface for all property types in the blueprint.
/// Provides type safety for polymorphic property handling.
abstract class Property {
  name: String

  hidden ref: Ref = internalPropertyRef("input.\(name).value")
}

function using(_value: ResolvableProperty, _input: (String) -> String) =
  if (_value.ref.isDefined()) _input.apply(_value.ref.value()) else ""

// ============================================================================
// APPLICATION ASSETS
// ============================================================================

/// Optional visual assets for the application.
/// Enhances the user experience in Küken's catalog and dashboards.
assets: AppAssets?

/// Container for application visual resources.
/// Currently supports application icons with plans for additional asset types.
class AppAssets {
  /// Application icon displayed in the Küken interface.
  /// Should be a square PNG, SVG, or WebP image, 256x256 pixels maximum.
  icon: Source
}

resources: AppResources?

typealias AppResources = Listing<AppResource>

abstract class AppResource {
  source: Source
}

class FileResource extends AppResource {
  source: FileURI
}

function file(path: String): FileResource = new { source = "\(FILE_PROTOCOL)\(path)" }

// ============================================================================
// RUNTIME REFERENCES
// ============================================================================
/// Runtime values that are only available during blueprint instantiation.
/// References provide access to system-generated values that don't exist when writing the blueprint,
/// such as instance names, generated IDs, or assigned ports. Use refs to inject these dynamic runtime
/// values into your configuration.
///
/// **Example:** `${refs.instance.name}` resolves to the actual instance name at deployment time.
const refs: RuntimeRefs

@Unlisted
local const function internalPropertyRef(_key: String): Ref = new Ref {
  key = "__REF__\(_key)__"
}

class Ref {
  key: String

  function isDefined(): Boolean = !value().isEmpty

  function value(): String = read("kuken:\(key)") as String
}

/// Runtime reference values injected by Küken during instance creation.
/// These values are generated or assigned by the system and made available as placeholders
/// that get resolved when the blueprint is instantiated into a runtime.
class RuntimeRefs {
  /// Instance-specific runtime values generated during deployment.
  const instance: InstanceRefs

  /// Network-related runtime values assigned by Küken.
  const network: NetworkRefs
}

/// Instance-level runtime values available during deployment.
/// These references resolve to properties of the specific instance being created.
class InstanceRefs {
  /// Unique identifier assigned to this instance.
  /// Can be used for tagging, logging, or internal references.
  const id: String = internalPropertyRef("instance.id").value()

  /// Generated unique name for this instance.
  /// Useful for container names, volume prefixes, or network identifiers.
  const name: String = internalPropertyRef("instance.name").value()
}

/// Network-related runtime values assigned during deployment.
/// These references provide access to ports and network configuration determined at runtime.
class NetworkRefs {
  const host: String = internalPropertyRef("network.host").value()

  /// Primary port assigned to this instance.
  /// Resolves to the actual port number allocated by Küken, useful when auto-assigning ports
  /// or when the port depends on other runtime conditions.
  const port: Int = internalPropertyRef("network.port").value().toInt()
}

// ============================================================================
// USER INPUT DEFINITIONS
// ============================================================================

/// User-configurable inputs presented during application setup.
/// Each input defines validation rules, display properties, and default values where applicable.
inputs: UserInputs

/// Base class for all user input types.
/// Subclasses provide type-specific validation and UI rendering hints.
abstract class UserInput extends Property {
  /// Unique programmatic identifier in kebab-case.
  /// Used in environment variable references and property interpolation.
  abstract name: InputId

  /// Human-readable display text shown to users.
  /// Should clearly describe the input's purpose without requiring technical knowledge.
  abstract label: DisplayLabel

  /// Input type identifier set automatically by subclasses.
  /// Used internally for UI rendering and validation.
  fixed type: String
}

/// Plain text input field for non-sensitive configuration values.
/// Use for usernames, email addresses, version strings, server names, or other visible text.
///
/// **Example:**
/// ```pkl
/// local ServerName = new TextInput {
///   name = "server-name"
///   label = "Server Name"
/// }
/// ```
class TextInput extends UserInput {
  fixed type: String = "text"

  /// Default text value if user doesn't specify one.
  default: String?
}

const function textInput(_name: InputId, _label: DisplayLabel) = new TextInput {
  name = _name
  label = _label
}

/// Password input field with masked character display.
/// Use for passwords, API keys, secret tokens, or any sensitive credentials.
/// Values are masked in the UI and should be stored securely by Küken.
///
/// **Example:**
/// ```pkl
/// local AdminPassword = new PasswordInput {
///   name = "admin-password"
///   label = "Administrator Password"
/// }
/// ```
class PasswordInput extends UserInput {
  abstract name: InputId
  abstract label: DisplayLabel
  fixed type: String = "password"
}

const function passwordInput(_name: InputId, _label: DisplayLabel) = new PasswordInput {
  name = _name
  label = _label
}

/// Network port number input with automatic range validation.
/// Use for HTTP/HTTPS ports, database connections, API endpoints, or custom service ports.
/// Validates port range and provides appropriate numeric input UI.
///
/// **Example:**
/// ```pkl
/// local HttpPort = new PortInput {
///   name = "http-port"
///   label = "HTTP Port"
///   default = 8080
/// }
/// ```
class PortInput extends UserInput {
  fixed type: String = "port"

  /// Default port number if user doesn't specify one.
  /// Should be a commonly used port that's unlikely to conflict with other services.
  default: PortNumber
}

const function portInput(_name: InputId, _label: DisplayLabel, _default: PortNumber) = new PortInput {
  name = _name
  label = _label
  default = _default
}

class SelectInput extends UserInput {
  fixed type: String = "select"

  /// Default text value if user doesn't specify one.
  default: String?
  items: Listing<String>
}

const function selectInput(_name: InputId, _label: DisplayLabel, _items: List<String>) = new SelectInput {
  name = _name
  label = _label
  items = _items.toListing()
}

class CheckboxInput extends UserInput {
  fixed type: String = "checkbox"

  default: Boolean?
}

const function checkboxInput(_name: InputId, _label: DisplayLabel) = new CheckboxInput {
  name = _name
  label = _label
}

class DataSizeInput extends UserInput {
  fixed type: String = "datasize"

  /// Default text value if user doesn't specify one.
  default: DataSize?
}

const function dataSizeInput(_name: InputId, _label: DisplayLabel) = new DataSizeInput {
  name = _name
  label = _label
}

// ============================================================================
// INSTANCE SETTINGS
// ============================================================================
instance: InstanceSettings

class InstanceSettings extends Base {
  @SourceCode
  startup: ResolvableProperty
}

// ============================================================================
// BUILD CONFIGURATION
// ============================================================================

/// Build configuration defining container image and runtime environment.
/// Küken processes this to pull images, configure variables, and start containers with proper settings.
build: BuildConfig

/// Complete build specification for the application container.
/// Combines Docker image selection with environment variable configuration.
class BuildConfig extends Base {
  /// Docker container image specification.
  docker: DockerConfig

  /// Environment variables passed to the container at runtime.
  /// Can include static values, user inputs, or a combination of both.
  environmentVariables: EnvironmentVariables
}

/// Docker container configuration specifying which image to use.
/// The image can be static, reference a user input, or use string interpolation.
class DockerConfig extends Base {
  /// Docker image reference to use for this application.
  /// Can be a static string like `"nginx:alpine"`, a direct [ResolvableProperty] reference, or interpolated like `"postgres:\(something)"`.
  ///
  /// Example:
  /// ```pkl
  /// const DockerImageVersion = textInput("docker-image-version", "Docker Image Version")
  ///
  /// build {
  ///   docker {
  ///     image = "postgres:\(DockerImageVersion)"
  ///   }
  /// }
  /// ```
  ///
  /// **Best practices:** Pin to specific versions for stability and consider using official images when available.
  image: ResolvableProperty
}

/// Environment variable definition for container configuration.
/// Variables are set before container startup and available to the application process.
/// Can reference user inputs for dynamic configuration.
class EnvironmentVariable extends Property {
  /// Environment variable name in UPPER_SNAKE_CASE following POSIX conventions.
  name: EnvVarName

  /// Variable value supporting multiple types.
  /// Numbers and booleans are automatically converted to strings. DataSize values are converted to bytes.
  /// User input references are resolved at runtime.
  value: EnvVarValue
}

const function env(_name: EnvVarName, _value: EnvVarValue): EnvironmentVariable = new {
  name = _name
  value = _value
}

// ============================================================================
// HOOKS
// ============================================================================

hooks: Hooks

class Hooks {
  onInstall: AppResource
}
