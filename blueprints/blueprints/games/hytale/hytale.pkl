module io.kuken.hytale.Hytale

amends "https://kuken.io/blueprints/reference/v1/Reference.pkl"

name = "Hytale"
version = "1.0.0"
url = "https://kuken.io"

assets {
  icon = "https://kuken.io/blueprints/icons/hytale.png"
}

// ============================================================================
// USER-DEFINED INPUT DEFINITIONS
// ============================================================================

/// Hytale warns that loading early plugins is unsupported and may cause stability issues.
local AcceptEarlyPlugins = checkboxInput("accept-early-plugins", "Accept Early Plugins")

/// Allow Server Operators.
local AllowOperators = checkboxInput("allow-operators", "Allow Server Operators")

/// Authentication mode.
local AuthMode = selectInput("auth-mode", "Auth Mode", List("Offline", "Authenticated"))

/// Hytale uses Sentry to track crashes. Disable Sentry during active plugin development.
local DisableSentry = checkboxInput("disable-sentry", "Disable Sentry")

/// Installs the Soruce Query plugin, so that your server responds to
/// Source Query A2S requests (player count, server name, etc.).
local InstallSourceQueryPlugin = (
  checkboxInput(
    "install-source-query-plugin",
    "Install Source Query plugin",
  )
) {
  default = true
}

/// The port that the Source Query plugin will use to respond to A2S requests.
/// This should be different from the main server port. Defaults to the game port + 1.
local SourceQueryPort =
  portInput(
    "source-query-plugin",
    "Source Query Port",
    refs.network.port + 1,
  )

/// Hytale provides a pre-trained AOT Java cache which can significantly improve boot times.
local UseAOTCache = (checkboxInput("use-aot-cache", "Use AOT Cache")) {
  default = true
}

inputs {
  AuthMode
  AcceptEarlyPlugins
  DisableSentry
  UseAOTCache
  AllowOperators
  InstallSourceQueryPlugin
  SourceQueryPort
}

// ============================================================================
// BUILD CONFIGURATION
// ============================================================================

build {
  docker {
    image = "ghcr.io/pterodactyl/games:hytale"
  }

  environmentVariables {
    new { name = "HYTALE_AUTH_MODE"; value = AuthMode }
    new { name = "HYTALE_ACCEPT_EARLY_PLUGINS"; value = AcceptEarlyPlugins }
    new { name = "DISABLE_SENTRY"; value = DisableSentry }
    new { name = "USE_AOT_CACHE"; value = UseAOTCache }
    new { name = "HYTALE_ALLOW_OP"; value = AllowOperators }
    new { name = "INSTALL_SOURCEQUERY_PLUGIN"; value = InstallSourceQueryPlugin }
    new { name = "QUERY_PORT"; value = SourceQueryPort }
  }
}

// ============================================================================
// INSTANCE SETTINGS
// ============================================================================

local authMode = using(AuthMode, (value) -> " --auth-mode \(value)")
local allowOperators = using(AllowOperators, (_) -> "--allow-operators")
local useAotCache = using(AllowOperators, (_) -> "XX:AOTCache=Server/HytaleServer.aot")
local acceptEarlyPlugins = using(AcceptEarlyPlugins, (_) -> "--accept-early-plugins")
local disableSentry = using(DisableSentry, (_) -> "--disable-sentry")

instance {
  startup =
    """
    java \(authMode) \(allowOperators) \(useAotCache) \(acceptEarlyPlugins) \(disableSentry) -Xms128 --assets Assets.zip --bind 0.0.0.0:\(refs.network.port) -jar Server/HytaleServer.jar
    """
}

// ============================================================================
// APLICATION RESOURCES & HOOKS
// ============================================================================

local InstallScript = file("install.sh")

resources {
  InstallScript
}

hooks {
  onInstall = InstallScript
}
